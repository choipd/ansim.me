<section id='map_section'>
  <div id='map_canvas' class='map' style='width:100%;height:600px;margin-bottom:2em;'>
  </div>
  <script type="text/javascript" src="https://maps.google.com/maps/api/js?sensor=true"></script>
  <script type="text/javascript">

  	var map;
  	var markers = [];

    function initializeMap() {
      var myOptions = {
        zoom: 15,
        center: new google.maps.LatLng(37.49227,126.89779),
        mapTypeId: google.maps.MapTypeId.ROADMAP
      };

      map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);

      google.maps.event.addListener(map, 'mouseup', fetch_data);
      google.maps.event.addListener(map, 'zoom_changed', fetch_data);
      google.maps.event.addListener(map, 'idle', fetch_data);
    }

    function exists_in_markers(id) {
      for(i in markers) {
        if (markers[i].id == id) return true 
      }
      return false;
    }

  	function place_markers(data) {
      var new_makers_count = 0;

  		for(var i=0; i < data.length; i++) {
        var id = data[i]._id;
        if (window.exists_in_markers(id)) {
          // skip
        } else {

          var pinColor = ["39b54a", "8dc73f", "fff200", "f26522", "ee1c24"][data[i].antibiotics-1];
          var pinImage = new google.maps.MarkerImage("http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|" + pinColor,
              new google.maps.Size(21, 34),
              new google.maps.Point(0,0),
              new google.maps.Point(10, 34));
          var pinShadow = new google.maps.MarkerImage("http://chart.apis.google.com/chart?chst=d_map_pin_shadow",
              new google.maps.Size(40, 37),
              new google.maps.Point(0, 0),
              new google.maps.Point(12, 35));

          marker = new google.maps.Marker({
            map:map,
            position: new google.maps.LatLng(data[i].coordinates[1], data[i].coordinates[0]),
            icon: pinImage,
            shadow: pinShadow
          });
          markers.push({ id: id, marker: marker });          
          new_makers_count++;
        }
  		}
      console.log("load " + data.length + " data & new "+ new_makers_count +" markers");
  	}

  	function fetch_data() {
			var url = '<%= hospitals_path(format: :json) %>';
			var map = this;
  		var bounds = map.getBounds();
			$jqXHR = $.getJSON(url, {
										north_east: bounds.getNorthEast().lng() + ',' + bounds.getNorthEast().lat(),
										south_west: bounds.getSouthWest().lng() + ',' + bounds.getSouthWest().lat()
								}).success(function(data) { 
									place_markers(data);
								});
  	}

    $(document).ready(function(){
      initializeMap();
    });
  </script>
</section>